# Django-Flask API Integration Guide

## Overview

The TerraScope platform consists of two integrated components:
- **Django Frontend** (port 8000): User registration, subscriptions, payments, and token generation
- **Flask API Backend** (port 5000): Data services for satellite observations and datasets

Users purchase subscriptions on the Django website, generate API tokens, and use those tokens to access the Flask API.

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    User Workflow                             │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
         ┌──────────────────────────────────┐
         │   Django Website (Port 8000)     │
         │   - User Registration            │
         │   - Subscription Purchase        │
         │   - Token Generation             │
         └──────────────────────────────────┘
                            │
                            │ Generates JWT Token
                            ▼
         ┌──────────────────────────────────┐
         │   User receives API Token         │
         │   (Valid until subscription ends) │
         └──────────────────────────────────┘
                            │
                            │ Uses token in API calls
                            ▼
         ┌──────────────────────────────────┐
         │   Flask API (Port 5000)          │
         │   - Validates Django Token       │
         │   - Serves Data (observations)   │
         │   - Applies Rate Limits          │
         └──────────────────────────────────┘
```

## How It Works

### 1. JWT Token Configuration

Both Django and Flask share the **same JWT secret key** to ensure tokens generated by Django can be validated by Flask.

**Django (frontend/terrascope/settings.py):**
```python
JWT_SECRET_KEY = os.getenv('JWT_SECRET_KEY', 'your-super-secret-jwt-key-change-in-production')
JWT_ALGORITHM = 'HS256'
```

**Flask (backend/app.py):**
```python
app.config['DJANGO_JWT_SECRET'] = os.getenv('JWT_SECRET_KEY', 'your-super-secret-jwt-key-change-in-production')
app.config['DJANGO_JWT_ALGORITHM'] = 'HS256'
```

### 2. Token Generation (Django)

When a user purchases a subscription and clicks "Generate Token" on their subscription detail page:

1. Django creates a JWT token with payload:
   ```json
   {
     "jti": "unique-token-id",
     "user_id": 123,
     "username": "john_doe",
     "email": "john@example.com",
     "subscription_id": 456,
     "product_id": 1,
     "product_name": "Professional Plan",
     "tier": "professional",
     "api_calls_limit": 10000,
     "data_limit_mb": 1000,
     "iat": 1733443200,
     "exp": 1733529600
   }
   ```

2. Token is signed with the shared JWT secret
3. Token is stored in Django's database (UserToken model)
4. Token is displayed to the user (one-time display)

### 3. Token Validation (Flask)

Flask has a custom decorator `@django_token_required` that:

1. Extracts token from `Authorization: Bearer <token>` header
2. Decodes and validates the token using Django's JWT secret
3. Checks token expiration
4. Verifies required claims (user_id, subscription_id, product_id)
5. Attaches decoded token data to `request.token_data`

### 4. Protected Endpoints

Flask API endpoints protected with Django tokens:

- **GET /api/me** - Get user info from token
- **GET /api/observations** - Get satellite observations (with filters)

## Setup Instructions

### Step 1: Set Environment Variable (Optional but Recommended)

Create a `.env` file in both `frontend/` and `backend/` directories:

```bash
JWT_SECRET_KEY=your-super-secret-jwt-key-change-in-production
```

Or set it as an environment variable:

**Windows (cmd):**
```cmd
set JWT_SECRET_KEY=your-super-secret-jwt-key-change-in-production
```

**Windows (PowerShell):**
```powershell
$env:JWT_SECRET_KEY="your-super-secret-jwt-key-change-in-production"
```

**Linux/Mac:**
```bash
export JWT_SECRET_KEY=your-super-secret-jwt-key-change-in-production
```

### Step 2: Install Flask Dependencies

```bash
cd backend
source env/Scripts/activate  # Windows Git Bash
# or: env\Scripts\activate.bat  # Windows CMD

pip install flask-cors
```

### Step 3: Start Both Servers

**Terminal 1 - Django:**
```bash
cd frontend
python manage.py runserver
# Runs on http://127.0.0.1:8000
```

**Terminal 2 - Flask:**
```bash
cd backend
source env/Scripts/activate  # or activate.bat
python app.py
# Runs on http://127.0.0.1:5000
```

## Usage Example

### 1. Get a Token from Django

1. Visit http://127.0.0.1:8000
2. Register/Login
3. Purchase a subscription (use Stripe test card: 4242 4242 4242 4242)
4. Go to Dashboard → View subscription details
5. Click "Generate Token"
6. Copy the generated token (it will look like: `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...`)

### 2. Test Token with Flask API

**Using cURL:**
```bash
curl -H "Authorization: Bearer YOUR_TOKEN_HERE" http://127.0.0.1:5000/api/me
```

**Using Postman:**
1. Create a new GET request to `http://127.0.0.1:5000/api/me`
2. Go to "Authorization" tab
3. Select "Bearer Token"
4. Paste your token
5. Send request

**Expected Response:**
```json
{
  "message": "Token validated successfully!",
  "user_id": 1,
  "username": "john_doe",
  "email": "john@example.com",
  "subscription_id": 1,
  "product_id": 1,
  "product_name": "Professional Plan",
  "tier": "professional",
  "api_calls_limit": 10000,
  "data_limit_mb": 1000,
  "token_id": "abc-123-def-456",
  "issued_at": "2025-12-05T10:30:00",
  "expires_at": "2025-12-15T10:30:00"
}
```

### 3. Get Observations

**Basic Request:**
```bash
curl -H "Authorization: Bearer YOUR_TOKEN_HERE" \
  http://127.0.0.1:5000/api/observations
```

**With Filters:**
```bash
curl -H "Authorization: Bearer YOUR_TOKEN_HERE" \
  "http://127.0.0.1:5000/api/observations?start_date=2025-01-01T00:00:00&limit=10"
```

**Response:**
```json
{
  "user": {
    "id": 1,
    "product": "Professional Plan"
  },
  "count": 10,
  "limit": 10,
  "observations": [
    {
      "id": 1,
      "timestamp": "2025-01-15T14:30:00",
      "latitude": 51.5074,
      "longitude": -0.1278,
      "value": 42.5,
      "satellite_id": "SAT-001"
    }
  ]
}
```

## Error Responses

### Missing Token
```json
{
  "error": "Authorization Required",
  "message": "No authorization header provided. Please include: Authorization: Bearer <your-token>"
}
```

### Invalid Token
```json
{
  "error": "Invalid Token",
  "message": "Token validation failed: Signature verification failed"
}
```

### Expired Token
```json
{
  "error": "Token Expired",
  "message": "Your subscription token has expired. Please renew your subscription."
}
```

## API Endpoints Reference

### Django Integration Endpoints (Flask)

| Method | Endpoint | Auth Required | Description |
|--------|----------|---------------|-------------|
| GET | `/api/me` | ✅ Django Token | Get user info from token |
| GET | `/api/observations` | ✅ Django Token | Get filtered observations |

### Legacy Endpoints (Flask JWT)

| Method | Endpoint | Auth Required | Description |
|--------|----------|---------------|-------------|
| POST | `/auth/login` | ❌ | Login with username/password |
| POST | `/auth/refresh` | ✅ Refresh Token | Get new access token |
| GET | `/observations` | ✅ Flask JWT | Get observations (old method) |

## Development Notes

### Token Expiration

- Tokens expire when the subscription expires
- Django automatically updates subscription status when expired
- Flask validates expiration on every request
- Users must purchase a new subscription to get new tokens

### Security Considerations

1. **HTTPS in Production**: Always use HTTPS in production
2. **Secret Key**: Use a strong, unique secret key in production
3. **Token Storage**: Tokens are stored securely in Django's database
4. **CORS**: Configured to only allow requests from Django frontend

### Troubleshooting

**Problem**: Token validation fails with "Signature verification failed"
- **Solution**: Ensure both Django and Flask use the same JWT_SECRET_KEY

**Problem**: CORS errors when calling from Django frontend
- **Solution**: Check that Flask CORS configuration includes Django's origin

**Problem**: "Token Expired" error
- **Solution**: Check subscription status in Django dashboard and renew if needed

## Testing

### Test Token Generation
```bash
cd frontend
python test_jwt.py
```

### Test Flask API
```bash
# Start Flask
cd backend
python app.py

# In another terminal, test health endpoint
curl http://127.0.0.1:5000/health

# Test with a real token from Django
curl -H "Authorization: Bearer <YOUR_TOKEN>" http://127.0.0.1:5000/api/me
```
